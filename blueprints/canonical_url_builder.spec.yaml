# canonical_url_builder.spec.yaml
# Source: canonical_url_builder.md [file:1]

spec_version: "1.0" # [file:1]
title: "MRF: SEO URL System, Canonicalization, Internal Linking, Sitemaps, Index Gates" # [file:1]

purpose: # [file:1]
  description: "Define exact rules for SEO money-page URL generation/validation, index policy, canonicalization, internal linking, and sitemap safety." # [file:1]
  goals: # [file:1]
    - "Generate + validate SEO money-page URLs." # [file:1]
    - "Decide INDEX vs NOINDEX deterministically." # [file:1]
    - "Canonicalize duplicates (synonyms, near-duplicates)." # [file:1]
    - "Generate internal link grids safely." # [file:1]
    - "Write sitemaps safely (INDEX-only)." # [file:1]

non_negotiables: # [file:1]
  - id: "tool_page_not_thin_template" # [file:1]
    rule: "Every SEO page must be a tool page (prefilled calculator + computed examples + checklist + risk blocks)." # [file:1]
  - id: "default_noindex" # [file:1]
    rule: "Default stance = NOINDEX until readiness checks pass." # [file:1]
  - id: "mandatory_canonicalization" # [file:1]
    rule: "Canonicalization required to prevent duplicates/cannibalization; synonyms collapse; product pages may canonical to HS pages when mapping is confidently unique." # [file:1]

routes: # [file:1]
  route_group: "(seo)" # [file:1]

  url_patterns: # [file:1]
    product_money_page: # [file:1]
      pattern: "/import-duty-vat-landed-cost/{clusterSlug}/from/{originIso}/to/{destIso}" # [file:1]
      example: "/import-duty-vat-landed-cost/lithium-batteries/from/india/to/south-africa" # [file:1]
      params: # [file:1]
        clusterSlug: "Product cluster slug." # [file:1]
        originIso: "Canonical origin identifier (seed uses lowercase country slugs)." # [file:1]
        destIso: "Destination slug; Phase 1 fixed to south-africa." # [file:1]

    hs_money_page: # [file:1]
      pattern: "/import-duty-vat-landed-cost/hs/{hs6}/from/{originIso}/to/{destIso}" # [file:1]
      params: # [file:1]
        hs6: "HS code (6 digits)." # [file:1]
        originIso: "Canonical origin identifier (seed uses lowercase country slugs)." # [file:1]
        destIso: "Destination slug; Phase 1 fixed to south-africa." # [file:1]

  destination_slug_rule: # [file:1]
    required_slug: "south-africa" # [file:1]
    forbid_iso_code_example: "ZA" # [file:1]
    lowercase_required: true # [file:1]

slug_generation: # [file:1]
  implementation_target: "src/lib/seo/slug.ts" # [file:1]

  clusterSlug: # [file:1]
    input_sources: # [file:1]
      - "product_cluster.name" # [file:1]
      - "optional known aliases" # [file:1]
    algorithm: # [file:1]
      steps: # [file:1]
        - "lowercase" # [file:1]
        - "replace '&' with 'and'" # [file:1]
        - "remove apostrophes" # [file:1]
        - "replace non-alphanumerics with '-'" # [file:1]
        - "collapse multiple hyphens" # [file:1]
        - "trim hyphens" # [file:1]
      max_length_chars: 60 # [file:1]
      truncation: # [file:1]
        method: "truncate_with_stable_hash_suffix_if_needed" # [file:1]
    reserved_words: # [file:1]
      - "hs" # [file:1]
    validation: # [file:1]
      disallow_exact: # [file:1]
        - "hs" # [file:1]

  originIso_destIso: # [file:1]
    rule: "Use canonical origin identifiers stored in DB/seed; keep consistent with seed approach (lowercase country slugs in examples)." # [file:1]
    phase_1: # [file:1]
      destIso_must_equal: "south-africa" # [file:1]

  hs6: # [file:1]
    format: # [file:1]
      digits: 6 # [file:1]
      numeric_only: true # [file:1]
    invalid_behavior: "reject_non_numeric_or_wrong_length_as_404" # [file:1]

canonicalization: # [file:1]
  implementation_target: "src/lib/seo/canonical.ts" # [file:1]

  canonical_targets_allowed: # [file:1]
    - "self" # [file:1]
    - "product_page" # [file:1]
    - "hs_page" # [file:1]

  product_to_hs_allowed_when: # [file:1]
    description: "Product+origin resolves confidently to a single HS6 and tariff rates exist for that route." # [file:1]

  decision_tree_for_product_request: # [file:1]
    - step: "synonym_collapse" # [file:1]
      rules: # [file:1]
        - if: "product_cluster.canonical_cluster_id exists" # [file:1]
          then: "canonical = canonical_cluster_url (same origin/dest)" # [file:1]
        - if: "multiple aliases map to same canonical" # [file:1]
          then: "all alias pages => NOINDEX + canonical to canonical page" # [file:1]

    - step: "hs_canonicalization_product_to_hs" # [file:1]
      rules: # [file:1]
        - if: "product_cluster_hs_map has exactly one candidate with confidence >= threshold AND tariff rates exist for that HS on that route" # [file:1]
          then: "canonical = hs_page_url" # [file:1]
        - else: "canonical remains product page" # [file:1]
      threshold_recommended: 0.85 # [file:1]

    - step: "near_duplicate_collapse" # [file:1]
      rules: # [file:1]
        - if: "two different clusters render identical computed blocks (same HS set, docs list, risks list, duty/VAT outputs for presets)" # [file:1]
          then: "mark one canonical; other NOINDEX" # [file:1]

  canonical_tag_requirements: # [file:1]
    index_pages: "Canonical must point to an INDEX-eligible canonical target." # [file:1]
    noindex_pages: "Still emit canonical to chosen canonical target to consolidate signals." # [file:1]

indexation_policy: # [file:1]
  implementation_target: "src/lib/seo/indexPolicy.ts" # [file:1]

  indexable_only_if_all_true: # [file:1]
    - "Prefilled calculator with valid HS mapping (or explicit HS)." # [file:1]
    - "Non-empty breakdown (at minimum duty + VAT)." # [file:1]
    - "At least 2 unique data-driven blocks (docs / preference / risk / computed scenarios)." # [file:1]
    - "At least 6 internal links." # [file:1]
    - "Freshness metadata present (tariff version + last updated)." # [file:1]

  auto_noindex_if_any_true: # [file:1]
    - "No HS candidates." # [file:1]
    - "Missing rate." # [file:1]
    - "Would output 'contact a broker' without numbers." # [file:1]
    - "Duplicates another page (canonicalize)." # [file:1]

  readiness_scoring: # [file:1]
    seed_policy: # [file:1]
      initial_pages_count: 200 # [file:1]
      initial_index_status: "NOINDEX" # [file:1]
      initial_readiness_score: 0 # [file:1]
    inputs: # [file:1]
      - "HS candidates exist." # [file:1]
      - "Tariff rates exist for >= 1 candidate." # [file:1]
      - "VAT module works." # [file:1]
      - "Docs exist." # [file:1]
      - "Risks exist (or explicitly 'none known')." # [file:1]
      - "Internal links >= 6." # [file:1]
    threshold: # [file:1]
      readinessScore_min: 70 # [file:1]
      hasComputedExampleOutputs_required: true # [file:1]

  computed_example_outputs_requirement: # [file:1]
    presets_required: 3 # [file:1]
    preset_examples: # [file:1]
      - "R10k" # [file:1]
      - "R50k" # [file:1]
      - "R250k" # [file:1]
    if_cannot_compute: "keep NOINDEX (e.g., missing tariff)" # [file:1]

internal_links: # [file:1]
  implementation_targets: # [file:1]
    - "src/lib/seo/internalLinks.ts" # [file:1]
  consumer_component: "SeoInternalLinks" # [file:1]

  minimum_links_for_index_pages: 6 # [file:1]

  generation_buckets_in_order: # [file:1]
    - bucket: "A_same_hs_other_origins" # [file:1]
      rules: # [file:1]
        - "If HS page: same hs6 with other top origins (e.g., China, India, etc.)." # [file:1]
        - "If product page: for each candidate HS6, link to HS pages for same origin (if they exist)." # [file:1]

    - bucket: "B_same_origin_related" # [file:1]
      rules: # [file:1]
        - "Product page: same origin, other clusters in same parent category." # [file:1]
        - "HS page: same origin, HS siblings (same chapter/heading) if taxonomy exists." # [file:1]

    - bucket: "C_tools_pages" # [file:1]
      links: # [file:1]
        - "/calculator" # [file:1]
        - "/hs-classifier" # [file:1]
        - "/compare" # [file:1]

    - bucket: "D_guides_or_hubs_useful_only" # [file:1]
      rule: "Include guide/hub pages only if genuinely useful and exist in routes (e.g., HS hub, directory/finder pages)." # [file:1]

  link_safety_rules: # [file:1]
    - "Only link to pages that are at least build-valid (even if NOINDEX)." # [file:1]
    - "Prefer linking to canonical targets (avoid known alias duplicates)." # [file:1]
    - "Never generate links that 404 due to missing seed combos." # [file:1]

  output_contract: # [file:1]
    InternalLink: # [file:1]
      required_fields: # [file:1]
        - "href" # [file:1]
        - "title" # [file:1]
        - "why" # [file:1]
        - "pageType" # [file:1]
      pageType_enum: # [file:1]
        - "product" # [file:1]
        - "hs" # [file:1]
        - "tool" # [file:1]

robots_and_sitemaps: # [file:1]
  implementation_targets: # [file:1]
    - "src/app/robots.ts" # [file:1]
    - "src/app/sitemap.ts" # [file:1]
    - "src/lib/seo/sitemapWriter.ts" # [file:1]

  sitemap_inclusion_rule: "Only INDEX pages may appear in sitemaps (enforce via tests)." # [file:1]

  sitemap_partitioning: # [file:1]
    required: true # [file:1]
    partition_dimensions: # [file:1]
      - "page_type (product vs hs)" # [file:1]
      - "origin (optional)" # [file:1]
      - "batch_size (e.g., 5000 URLs per sitemap)" # [file:1]

  rollout_strategy: # [file:1]
    week_1_index_pages: "20-40" # [file:1]
    rule: "Only expand indexing for pages that pass readiness gates." # [file:1]

tests_required: # [file:1]
  unit_tests: # [file:1]
    - "SEO meta builder returns correct robots + canonical for each page state." # [file:1]
    - "Slugify is deterministic + stable." # [file:1]
    - "Canonical decision tree produces expected canonical for synonym cluster, product->HS canonical, and self-canonical." # [file:1]

  e2e_tests: # [file:1]
    - "NOINDEX page never appears in sitemap; INDEX page does." # [file:1]
    - "Build-pass: pages without tariffs remain NOINDEX with explicit blocker reason." # [file:1]

acceptance_criteria: # [file:1]
  definition_of_done: # [file:1]
    - "Every SEO request resolves to deterministic slug + canonical." # [file:1]
    - "INDEX/NOINDEX is purely rule-driven (manual toggles not needed except admin overrides)." # [file:1]
    - "Sitemap output cannot accidentally include NOINDEX pages." # [file:1]
    - "Every INDEX page shows >= 6 internal links and 3 computed presets." # [file:1]
    - "Synonyms and duplicates reliably collapse to one canonical target." # [file:1]
